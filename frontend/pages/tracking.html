<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¡çœ è¿½è¹¤ - è¿½è¹¤èˆ‡æ„Ÿæ¸¬</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
    <main class="container">
        <header class="app-header">
            <div class="nav-container">
                <button class="menu-toggle" id="menuToggle" aria-label="åˆ‡æ›åŠŸèƒ½è¡¨">â˜°</button>
                <h1>ğŸ’¤ ç¡çœ è¿½è¹¤ç³»çµ±</h1>
                <nav class="nav-menu" id="navMenu">
                    <a href="../index.html" class="nav-link">ğŸ  é¦–é </a>
                    <a href="tracking.html" class="nav-link active">ğŸ“¡ è¿½è¹¤æ„Ÿæ¸¬</a>
                    <a href="monitoring.html" class="nav-link">ğŸ‘ï¸ æ™ºèƒ½ç›£æ§</a>
                    <a href="dashboard.html" class="nav-link">ğŸ“Š å„€è¡¨æ¿</a>
                    <a href="history.html" class="nav-link">ğŸ“‹ æ­·å²</a>
                    <a href="settings.html" class="nav-link">âš™ï¸ è¨­å®š</a>
                </nav>
            </div>
            <p class="subtitle">é‹å‹•å’Œè²éŸ³è¿½è¹¤</p>
        </header>

        <div class="content">
            <!-- è¿½è¹¤æ§åˆ¶å€ -->
            <section class="tracking-section">
                <h2>ğŸ¯ è¿½è¹¤æ§åˆ¶</h2>
                
                <div class="tracking-info">
                    <div class="info-item">
                        <span class="info-label">ç‹€æ…‹ï¼š</span>
                        <span class="info-value" id="trackingStatus">æœªå•Ÿå‹•</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">æ¡æ¨£æ•¸é‡ï¼š</span>
                        <span class="info-value" id="sampleCount">0</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">é‹è¡Œæ™‚é–“ï¼š</span>
                        <span class="info-value" id="runningTime">00:00</span>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" id="startTrackingBtn">â–¶ï¸ é–‹å§‹è¿½è¹¤</button>
                    <button class="btn btn-secondary" id="stopTrackingBtn" disabled>â¹ï¸ åœæ­¢è¿½è¹¤</button>
                </div>

                <div class="tracking-stats">
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ“Š</div>
                        <div class="stat-name">é‹å‹•æ¨£æœ¬</div>
                        <div class="stat-value" id="motionSamples">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ”Š</div>
                        <div class="stat-name">è²éŸ³æ¨£æœ¬</div>
                        <div class="stat-value" id="soundSamples">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ“ˆ</div>
                        <div class="stat-name">å¹³å‡é‹å‹•</div>
                        <div class="stat-value" id="avgMotion">--</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ“‰</div>
                        <div class="stat-name">å¹³å‡è²éŸ³</div>
                        <div class="stat-value" id="avgSound">--</div>
                    </div>
                </div>
            </section>

            <!-- å³æ™‚ç›£æ¸¬å€ -->
            <section class="realtime-section">
                <h2>ğŸ“¡ å³æ™‚ç›£æ¸¬</h2>
                
                <div class="sensor-data">
                    <div class="sensor-item">
                        <h3>åŠ é€Ÿåº¦è¨ˆ (é‹å‹•)</h3>
                        <div class="sensor-reading">
                            <div class="axis">
                                <span class="label">Xè»¸ï¼š</span>
                                <span class="value" id="accelX">0.0</span>
                                <span class="unit">m/sÂ²</span>
                            </div>
                            <div class="axis">
                                <span class="label">Yè»¸ï¼š</span>
                                <span class="value" id="accelY">0.0</span>
                                <span class="unit">m/sÂ²</span>
                            </div>
                            <div class="axis">
                                <span class="label">Zè»¸ï¼š</span>
                                <span class="value" id="accelZ">0.0</span>
                                <span class="unit">m/sÂ²</span>
                            </div>
                            <div class="axis">
                                <span class="label">åˆåŠ›å€¼ï¼š</span>
                                <span class="value" id="accelMagnitude">0.0</span>
                                <span class="unit">m/sÂ²</span>
                            </div>
                        </div>
                        <div class="graph-placeholder" id="motionGraph">
                            [é‹å‹•æ³¢å½¢åœ–]
                        </div>
                    </div>

                    <div class="sensor-item">
                        <h3>éº¥å…‹é¢¨ (è²éŸ³)</h3>
                        <div class="sensor-reading">
                            <div class="axis">
                                <span class="label">è²éŸ³ç´šåˆ¥ï¼š</span>
                                <span class="value" id="soundLevel">0</span>
                                <span class="unit">dB</span>
                            </div>
                            <div class="axis">
                                <span class="label">RMSå€¼ï¼š</span>
                                <span class="value" id="rmsValue">0.0</span>
                                <span class="unit">Pa</span>
                            </div>
                            <div class="axis">
                                <span class="label">å³°å€¼ï¼š</span>
                                <span class="value" id="peakValue">0</span>
                                <span class="unit">dB</span>
                            </div>
                        </div>
                        <div class="graph-placeholder" id="soundGraph">
                            [è²éŸ³æ³¢å½¢åœ–]
                        </div>
                    </div>
                </div>
            </section>

            <!-- è¿½è¹¤æ•¸æ“šæ­·å² -->
            <section class="data-history-section">
                <h2>ğŸ“‹ æœ€è¿‘è¿½è¹¤æ•¸æ“š</h2>
                
                <div class="data-controls">
                    <button class="btn btn-small" onclick="clearTrackingData()">æ¸…ç©ºæ•¸æ“š</button>
                    <button class="btn btn-small" onclick="exportTrackingData()">åŒ¯å‡ºæ•¸æ“š</button>
                </div>

                <div id="recentDataContainer" class="data-list">
                    <p style="color: #999; text-align: center;">è¿½è¹¤ä¸­æœƒé¡¯ç¤ºæœ€è¿‘æ•¸æ“š...</p>
                </div>
            </section>
        </div>

        <footer class="app-footer">
            <p>è¼•é‡ç¡çœ è¿½è¹¤ç³»çµ± v1.0 | è¿½è¹¤èˆ‡æ„Ÿæ¸¬</p>
        </footer>
    </main>

    <script src="../js/api.js"></script>
    <script src="../js/tracker.js"></script>
    <script src="../js/smartAwake.js"></script>
    <script>
        // æ‰‹æ©Ÿå°èˆªåŠŸèƒ½
        document.getElementById('menuToggle').addEventListener('click', function() {
            const navMenu = document.getElementById('navMenu');
            navMenu.classList.toggle('active');
        });

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function() {
                document.getElementById('navMenu').classList.remove('active');
            });
        });

        document.addEventListener('click', function(e) {
            const navMenu = document.getElementById('navMenu');
            const menuToggle = document.getElementById('menuToggle');
            if (!navMenu.contains(e.target) && !menuToggle.contains(e.target)) {
                navMenu.classList.remove('active');
            }
        });

        // è¿½è¹¤ç®¡ç†
        let trackingActive = false;
        let trackingStartTime = null;
        let sampleBuffer = [];
        let timerInterval = null;

        const tracker = new Tracker();
        
        // åˆå§‹åŒ– Tracker å›èª¿
        tracker.onData = function(sample) {
            sampleBuffer.push(sample);
            updateTrackingDisplay(sample);
        };

        document.getElementById('startTrackingBtn').addEventListener('click', () => {
            trackingActive = true;
            trackingStartTime = Date.now();
            sampleBuffer = [];
            
            document.getElementById('startTrackingBtn').disabled = true;
            document.getElementById('stopTrackingBtn').disabled = false;
            document.getElementById('trackingStatus').textContent = 'è¿½è¹¤ä¸­...';
            document.getElementById('trackingStatus').style.color = '#4CAF50';
            
            tracker.startTracking();
            startTimer();
        });

        document.getElementById('stopTrackingBtn').addEventListener('click', () => {
            trackingActive = false;
            
            document.getElementById('startTrackingBtn').disabled = false;
            document.getElementById('stopTrackingBtn').disabled = true;
            document.getElementById('trackingStatus').textContent = 'å·²åœæ­¢';
            document.getElementById('trackingStatus').style.color = '#FF9800';
            
            tracker.stopTracking();
            stopTimer();
            
            // ä¿å­˜æ•¸æ“šåˆ° localStorage
            const existing = JSON.parse(localStorage.getItem('trackingSamples') || '[]');
            existing.push(...sampleBuffer);
            localStorage.setItem('trackingSamples', JSON.stringify(existing));
        });

        function startTimer() {
            timerInterval = setInterval(() => {
                if (!trackingStartTime) return;
                
                const elapsed = Date.now() - trackingStartTime;
                const seconds = Math.floor(elapsed / 1000);
                const minutes = Math.floor(seconds / 60);
                
                document.getElementById('runningTime').textContent = 
                    `${String(minutes).padStart(2, '0')}:${String(seconds % 60).padStart(2, '0')}`;
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function updateTrackingDisplay(sample) {
            // æ›´æ–°è¨ˆæ•¸
            document.getElementById('sampleCount').textContent = sampleBuffer.length;
            
            // æ›´æ–°åŠ é€Ÿåº¦è¨ˆ
            if (sample.motion) {
                document.getElementById('accelX').textContent = (sample.motion.x || 0).toFixed(2);
                document.getElementById('accelY').textContent = (sample.motion.y || 0).toFixed(2);
                document.getElementById('accelZ').textContent = (sample.motion.z || 0).toFixed(2);
                
                const magnitude = Math.sqrt(
                    (sample.motion.x || 0) ** 2 + 
                    (sample.motion.y || 0) ** 2 + 
                    (sample.motion.z || 0) ** 2
                );
                document.getElementById('accelMagnitude').textContent = magnitude.toFixed(2);
            }
            
            // æ›´æ–°éº¥å…‹é¢¨
            if (sample.sound !== undefined) {
                document.getElementById('soundLevel').textContent = Math.round(sample.sound);
                document.getElementById('rmsValue').textContent = sample.rms ? sample.rms.toFixed(4) : '0.0000';
            }
            
            // æ›´æ–°çµ±è¨ˆ
            updateStatistics();
            updateRecentData();
        }

        function updateStatistics() {
            if (sampleBuffer.length === 0) return;
            
            let motionCount = 0, soundCount = 0;
            let motionSum = 0, soundSum = 0;
            
            sampleBuffer.forEach(s => {
                if (s.motion) {
                    motionCount++;
                    motionSum += s.motion.magnitude || 0;
                }
                if (s.sound !== undefined) {
                    soundCount++;
                    soundSum += s.sound;
                }
            });
            
            document.getElementById('motionSamples').textContent = motionCount;
            document.getElementById('soundSamples').textContent = soundCount;
            document.getElementById('avgMotion').textContent = 
                motionCount > 0 ? (motionSum / motionCount).toFixed(2) : '--';
            document.getElementById('avgSound').textContent = 
                soundCount > 0 ? Math.round(soundSum / soundCount) : '--';
        }

        function updateRecentData() {
            if (sampleBuffer.length === 0) return;
            
            const recent = sampleBuffer.slice(-10).reverse();
            const html = recent.map((s, i) => {
                const time = new Date(s.createdAt).toLocaleTimeString('zh-TW');
                const motion = s.motion ? s.motion.magnitude?.toFixed(2) : '--';
                const sound = s.sound !== undefined ? Math.round(s.sound) : '--';
                
                return `
                    <div class="data-item">
                        <span class="time">${time}</span>
                        <span class="motion">é‹å‹•: ${motion}</span>
                        <span class="sound">è²éŸ³: ${sound}dB</span>
                    </div>
                `;
            }).join('');
            
            document.getElementById('recentDataContainer').innerHTML = html;
        }

        function clearTrackingData() {
            if (confirm('ç¢ºå®šè¦æ¸…ç©ºç•¶å‰è¿½è¹¤æ•¸æ“šå—ï¼Ÿ')) {
                sampleBuffer = [];
                document.getElementById('sampleCount').textContent = '0';
                document.getElementById('recentDataContainer').innerHTML = 
                    '<p style="color: #999; text-align: center;">æ•¸æ“šå·²æ¸…ç©º</p>';
            }
        }

        function exportTrackingData() {
            if (sampleBuffer.length === 0) {
                alert('æ²’æœ‰æ•¸æ“šå¯åŒ¯å‡º');
                return;
            }
            
            const csv = [
                ['æ™‚é–“', 'é‹å‹•(X)', 'é‹å‹•(Y)', 'é‹å‹•(Z)', 'é‹å‹•åˆåŠ›', 'è²éŸ³(dB)', 'RMS'].join(','),
                ...sampleBuffer.map(s => [
                    new Date(s.createdAt).toLocaleTimeString('zh-TW'),
                    s.motion?.x?.toFixed(2) || '',
                    s.motion?.y?.toFixed(2) || '',
                    s.motion?.z?.toFixed(2) || '',
                    s.motion?.magnitude?.toFixed(2) || '',
                    Math.round(s.sound || 0),
                    s.rms?.toFixed(4) || ''
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `tracking-${Date.now()}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
